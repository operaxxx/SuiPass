#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# Stage 1: Quick checks (fail fast)
echo "📝 Checking formatting..."
pnpm format:check || exit 1

# Stage 2: Code quality
echo "🔍 Running type checking..."
pnpm type-check || exit 1

echo "🧹 Running linting..."
pnpm lint || exit 1

# Stage 3: Security checks
echo "🔒 Running security audit..."
pnpm security:check || exit 1

# Stage 4: Smart contract checks (if contracts changed)
if git diff --cached --name-only | grep -q "packages/contracts/"; then
    echo "📦 Running smart contract checks..."
    cd packages/contracts
    pnpm lint || exit 1
    pnpm build || exit 1
    cd ../..
fi

# Stage 5: Tests (quick smoke test)
echo "🧪 Running smoke tests..."
pnpm test -- --run --reporter=verbose || exit 1

echo "✅ All pre-commit checks passed!"